<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>一些常用的Nginx+Passenger配置 | Recording</title>
  <meta name="author" content="jibing57">
  
  <meta name="description" content="AWS, 阅读, Architecture, PostgreSQL">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="一些常用的Nginx+Passenger配置"/>
  <meta property="og:site_name" content="Recording"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  
  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111771042-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?59d3e14cdc96877383afed646f44d216";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Recording</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/books" title="Douban">
			  <i class="fa fa-book"></i>Douban
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header ">		
			<h1 class="title "> 一些常用的Nginx+Passenger配置</h1>
		</div>		
	




   <style type="text/css">
           img, video {
                -webkit-box-shadow:0 0 10px rgba(0, 0, 0, .5);  
                -moz-box-shadow:0 0 10px rgba(0, 0, 0, .5);  
                box-shadow:0 0 10px rgba(0, 0, 0, .5);  
           }
   </style>



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>摘记一些常用的nginx和passenger(Passenger + Nginx)配置</p>
<h2 id="Basic验证"><a href="#Basic验证" class="headerlink" title="Basic验证"></a>Basic验证</h2><p>测试环境的服务要放到互联网上时，如果为了避免测试服务的内容被搜索引擎收录，或者只提供给部分用户试用时，可以设置Basic Auth来限制访问。Basic Auth可以在应用层做，也可以在Nginx侧简单的设置。</p>
<p>如下是Nginx侧的设置方法, 摘录自Nginx官网文章<a href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/" target="_blank" rel="external">Restricting Access with HTTP Basic Authentication</a></p>
<h3 id="设置htpasswd"><a href="#设置htpasswd" class="headerlink" title="设置htpasswd"></a>设置htpasswd</h3><ol>
<li>确保apache2-utils (Debian, Ubuntu) 或者 httpd-tools (RHEL/CentOS/Oracle Linux)已经安装。</li>
<li><p>创建htpasswd文件, 使用<code>-c</code>来创建新文件。如下是给用户名carl生成.htpasswd文件，在提示信息中输入访问密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ sudo htpasswd -c /etc/nginx/.htpasswd carl</div><div class="line">New password:</div><div class="line">Re-type new password:</div><div class="line">Adding password for user carl</div><div class="line">$</div></pre></td></tr></table></figure>
</li>
<li><p>如果要创建新的用户，那么去掉<code>-c</code>参数，往htpasswd文件中添加用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ sudo htpasswd /etc/nginx/.htpasswd shen</div><div class="line">New password:</div><div class="line">Re-type new password:</div><div class="line">Adding password for user shen</div><div class="line">$</div></pre></td></tr></table></figure>
</li>
<li><p>确认.htpasswd文件中是否包含了刚设置的用户carl和shen</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/nginx/.htpasswd</div><div class="line">carl:$apr1$ofR4vRu4$RwMK.HQawTD8/v.YOA2/d.</div><div class="line">shen:$apr1$c1vlrfgt$TqDy9JDsNcGyfTzcSOPLG0</div><div class="line">$</div></pre></td></tr></table></figure>
</li>
</ol>
<a id="more"></a>
<h3 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h3><p>使用<code>auth_basic</code>和<code>auth_basic_user_file</code>来在nginx侧配置Basic Authentication</p>
<ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic" target="_blank" rel="external">auth_basic</a>: 可以设置一个string或者off，off表示关闭Basic Authentication</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html#auth_basic_user_file" target="_blank" rel="external">auth_basic_user_file</a>: 指定passwd验证文件</li>
</ul>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">      listen       80;</div><div class="line">      server_name  test.jibing57.com;</div><div class="line">      root         /opt/app/web/hexo;</div><div class="line">      auth_basic  &quot;Administrator’s Area&quot;;</div><div class="line">      auth_basic_user_file .htpasswd;</div><div class="line"></div><div class="line">      location /images/ &#123;</div><div class="line">          auth_basic off;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说明：</p>
<ul>
<li>auth_basic 不为off，表示开启Basic Authentication</li>
<li><code>auth_basic_user_file .htpasswd</code> 表示使用密码文件.htpasswd</li>
<li>location /images/中<code>auth_basic off;</code>标明访问/images/下文件不需要验证。</li>
</ul>
<h3 id="试验"><a href="#试验" class="headerlink" title="试验"></a>试验</h3><p>如上配置且重启过nginx后。<br>访问<a href="http://test.jibing57.com" target="_blank" rel="external">http://test.jibing57.com</a>就会弹出验证框<br><img src="/images/Nginx/auth_basic_pop_username.png" alt="auth_basic_pop_username.png"></p>
<p>访问<a href="http://test.jibing57.com/images/AWS/S3/steve.jpeg" target="_blank" rel="external">http://test.jibing57.com/images/AWS/S3/steve.jpeg</a> 就不需要验证<br><img src="/images/Nginx/auth_basic_no_basic_path.png" alt="auth_basic_no_basic_path.png"></p>
<hr>
<h2 id="https配置"><a href="#https配置" class="headerlink" title="https配置"></a>https配置</h2><h3 id="https配置和例子"><a href="#https配置和例子" class="headerlink" title="https配置和例子"></a>https配置和例子</h3><p>配置https的官方链接: <a href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank" rel="external">Configuring HTTPS servers</a><br>ssl module参数配置说明链接: <a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html" target="_blank" rel="external">Module ngx_http_ssl_module</a></p>
<p>典型配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">      listen	   443 ssl;</div><div class="line">      listen	   [::]:443 ssl;</div><div class="line">      server_name  test.jibing57.com;</div><div class="line">      ssl_session_cache   shared:SSL:10m;</div><div class="line">      ssl_session_timeout 10m;</div><div class="line">      keepalive_timeout   70;</div><div class="line">      ssl_certificate     cert/www.jibing57.com.pem;</div><div class="line">      ssl_certificate_key cert/www.jibing57.com.key;</div><div class="line">      ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">      ssl_ciphers         HIGH:!aNULL:!MD5;</div><div class="line"></div><div class="line">      ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="延伸阅读-SNI"><a href="#延伸阅读-SNI" class="headerlink" title="延伸阅读: SNI"></a>延伸阅读: SNI</h3><h4 id="SNI说明"><a href="#SNI说明" class="headerlink" title="SNI说明"></a>SNI说明</h4><p>SNI产生的背景，如下文字来自<a href="https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E6%8C%87%E7%A4%BA" target="_blank" rel="external">维基百科</a></p>
<blockquote>
<p>基于名称的虚拟主机允许多个DNS主机名由同一IP地址上的单个服务器（通常为Web服务器）托管。为了实现这一点，服务器使用客户端提供的主机名作为协议的一部分（对于HTTP，名称显示在主机头中）。但是，当使用HTTPS时，TLS握手发生在服务器看到任何HTTP头之前。因此，服务器不可能使用HTTP主机头中的信息来决定呈现哪个证书，并且因此只有由同一证书覆盖的名称才能由同一IP地址提供。</p>
</blockquote>
<p>SNI是一个扩展的TLS计算机联网协议，在握手阶段由client发送的client hello中添加Extension的Type为server_name的方式来告诉服务端要访问的server name。服务端根据server name来返回对应的ssl证书信息。从而允许服务端支持在同一个IP，同一个端口上根据不同的server name来部署不同的https证书。</p>
<h4 id="SNI抓包看协议"><a href="#SNI抓包看协议" class="headerlink" title="SNI抓包看协议"></a>SNI抓包看协议</h4><p>如下是通过Wireshark抓取的包。我访问www.qq.com时，握手阶段的Client Hello中，有type=0x0000的server_nam的extension。<br><img src="/images/Nginx/sni_client_hello_on_qq_com.png" alt="sni_client_hello_on_qq_com.png"></p>
<h4 id="Nginx查看SNI支持"><a href="#Nginx查看SNI支持" class="headerlink" title="Nginx查看SNI支持"></a>Nginx查看SNI支持</h4><p>Nginx下使用<code>nginx -V</code>来检测nginx是否支持SNI, 如果有<code>TLS SNI support enabled</code>说明nginx支持SNI<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ nginx -V</div><div class="line">...</div><div class="line">TLS SNI support enabled</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h4 id="SNI参考资料"><a href="#SNI参考资料" class="headerlink" title="SNI参考资料"></a>SNI参考资料</h4><ul>
<li>Nginx官方文档对SNI的简要介绍<a href="http://nginx.org/en/docs/http/configuring_https_servers.html#sni" target="_blank" rel="external">Server Name Indication</a></li>
<li>SNI wikipedia - <a href="https://en.wikipedia.org/wiki/Server_Name_Indication" target="_blank" rel="external">Server Name Indication</a></li>
<li>SNI in <a href="https://tools.ietf.org/html/rfc6066#page-6" target="_blank" rel="external">RFC 6066</a></li>
</ul>
<h2 id="Nginx-444"><a href="#Nginx-444" class="headerlink" title="Nginx 444"></a>Nginx 444</h2><p>Http code 444是nginx自定义的状态码，不是标准的HTTP code, 表示关闭一个连接，而不返回任何的响应头。</p>
<h3 id="配置不响应未知Host的方法"><a href="#配置不响应未知Host的方法" class="headerlink" title="配置不响应未知Host的方法"></a>配置不响应未知Host的方法</h3><p>配置Nginx不响应未知Host的请求的方法参见之前文章<a href="/2019/02/28/nginx_444_and_307/" title="Nginx的HTTP Code444和307设置">Nginx的HTTP Code444和307设置</a></p>
<h3 id="配置5xx回应为不响应"><a href="#配置5xx回应为不响应" class="headerlink" title="配置5xx回应为不响应"></a>配置5xx回应为不响应</h3><p>配置5xx回应为444。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">  ...</div><div class="line">  error_page 500 502 503 504 =444 @blackhole;</div><div class="line"></div><div class="line">  location @blackhole &#123;</div><div class="line">    return 444;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Nginx-redirect配置"><a href="#Nginx-redirect配置" class="headerlink" title="Nginx redirect配置"></a>Nginx redirect配置</h2><p>Nginx 301和307 redirect配置参见之前文章 <a href="/2019/02/28/nginx_444_and_307/" title="Nginx的HTTP Code444和307设置">Nginx的HTTP Code444和307设置</a></p>
<p>基础配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    server_name www.fake.com;</div><div class="line">    if ($request_method = POST) &#123;</div><div class="line">        return 307 https://www.fakesite.com$request_uri;</div><div class="line">    &#125;</div><div class="line">    return 301 https://www.fakesite.com$request_uri;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配置gzip压缩"><a href="#配置gzip压缩" class="headerlink" title="配置gzip压缩"></a>配置gzip压缩</h2><p>Nginx gzip模块配置说明<a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" target="_blank" rel="external">ngx_http_gzip_module</a><br>Nginx gzip_static模块配置说明<a href="http://nginx.org/en/docs/http/ngx_http_gzip_static_module.html" target="_blank" rel="external">ngx_http_gzip_static_module</a></p>
<h3 id="gzip配置"><a href="#gzip配置" class="headerlink" title="gzip配置"></a>gzip配置</h3><p>典型配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  ...</div><div class="line">  server &#123;</div><div class="line">    ...</div><div class="line">    # gzip module</div><div class="line">    gzip on;  # 是否开启gzip模块，on表示开启，off表示关闭；</div><div class="line">    gzip_buffers 16 8k;</div><div class="line">    gzip_min_length 1024;</div><div class="line">    gzip_http_version 1.1;</div><div class="line">    gzip_comp_level 6;</div><div class="line">    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;</div><div class="line">    gzip_vary on;</div><div class="line">    gzip_proxied any;</div><div class="line">    gzip_disable &quot;msie6&quot;;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中:</p>
<ul>
<li><code>gzip on</code>: 是否开启gzip模块，on表示开启，off表示关闭；</li>
<li><code>gzip_buffers 16 8k</code>: 设置临时内存空间，8k表示申请单位是8k，16表示每次以16个8k的单位去申请</li>
<li><code>gzip_min_length 1024</code>: 表示压缩的最小size，如果文件小于1024，则不会被压缩。</li>
<li><code>gzip_http_version 1.1</code>: 表示gzip基于http 1.1进行压缩，默认就是HTTP 1.1</li>
<li><code>gzip_comp_level 6</code>: 表示压缩等级，数字越大，压缩越好，但越占用CPU，默认值是1.</li>
<li><code>gzip_types</code>: 表示需要进行压缩的Content-Type的类型，文本类型的js,css,text,xml,json等压缩后效果比较明显</li>
<li><code>gzip_proxied</code>: Nginx作为反向代理的时候启用，开启或者关闭后端服务器返回的结果，匹配的前提是后端服务器必须要返回包含”Via”的 header头。<ul>
<li>默认是 off</li>
<li>off - 关闭所有的代理结果数据的压缩</li>
<li>expired - 启用压缩，如果header头中包含 “Expires” 头信息</li>
<li>no-cache - 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息</li>
<li>no-store - 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息</li>
<li>private - 启用压缩，如果header头中包含 “Cache-Control:private” 头信息</li>
<li>no_last_modified - 启用压缩,如果header头中不包含 “Last-Modified” 头信息</li>
<li>no_etag - 启用压缩 ,如果header头中不包含 “ETag” 头信息</li>
<li>auth - 启用压缩 , 如果header头中包含 “Authorization” 头信息</li>
<li>any - 无条件启用压缩</li>
<li>gzip_proxied [off|expired|no-cache|no-store|private|no_last_modified|no_etag|auth|any] …</li>
</ul>
</li>
<li><code>gzip_vary on</code>: 是否在http header中添加Vary: Accept-Encoding，建议开启</li>
<li><code>gzip_disable &quot;msie6&quot;</code>: gzip_disable “msie6”的意思: disable compression for Internet Explorer versions 4-6, special mask “msie6” corresponds to the regular expression “MSIE [4-6].“, but works faster.</li>
</ul>
<p>Reference:<br>gzip参数的中文详细说明，可参照博文<a href="https://blog.csdn.net/liupeifeng3514/article/details/79018334" target="_blank" rel="external">Nginx Gzip模块启用和配置指令详解</a></p>
<h3 id="gzip-static配置"><a href="#gzip-static配置" class="headerlink" title="gzip_static配置"></a>gzip_static配置</h3><p>gzip_static配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  ...</div><div class="line">  server &#123;</div><div class="line">    ...</div><div class="line">    location ~ &quot;^/assets/.+-[0-9a-f]&#123;32&#125;.*&quot; &#123;</div><div class="line">      gzip_static on;</div><div class="line">      expires     30d;</div><div class="line">      add_header  Cache-Control public;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>其中: </p>
<ul>
<li><code>gzip_static on|off|always</code>: 开启时，会读取预先压缩的文件，如果有gz文件，就直接返回gz文件的内容。有些老旧浏览器可能不兼容gzip格式，启用gzip_static时，最好同时保留原始静态文件。</li>
</ul>
<h2 id="配置最大上传文件限制"><a href="#配置最大上传文件限制" class="headerlink" title="配置最大上传文件限制"></a>配置最大上传文件限制</h2><p>设置client允许上传的最大文件size。<br>Nginx官方说明<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" target="_blank" rel="external">ngx_http_core_module</a></p>
<p>典型配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  ...</div><div class="line">  server &#123;</div><div class="line">    ...</div><div class="line">    client_max_body_size 100m;</div><div class="line">    client_body_buffer_size 256k;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h2><p>Nginx日志设置的guide: <a href="https://docs.nginx.com/nginx/admin-guide/monitoring/logging/" target="_blank" rel="external">Configuring Logging</a><br>Nginx http log module的说明: <a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="external">Module ngx_http_log_module</a></p>
<p>日志设置例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  ...</div><div class="line">  log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">                    &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">                    &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class="line"></div><div class="line">  log_format  timer  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">                     &apos;$status $body_bytes_sent &quot;$http_user_agent&quot; request_time $request_time (s)&apos;;</div><div class="line">  ...</div><div class="line">  server &#123;</div><div class="line">    ...</div><div class="line">    access_log  /var/log/nginx/access.log  main;</div><div class="line">    error_log  /var/log/nginx/error.log  notice;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="主目录非根目录nginx配置"><a href="#主目录非根目录nginx配置" class="headerlink" title="主目录非根目录nginx配置"></a>主目录非根目录nginx配置</h2><p>一篇root和alias区别的文章: <a href="https://www.techcoil.com/blog/understanding-the-difference-between-the-root-and-alias-directives-in-nginx/" target="_blank" rel="external">Understanding the difference between the root and alias directives in Nginx</a></p>
<p>nginx+passenger配置子目录的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">location /movieticket &#123;</div><div class="line">    alias /opt/app/movieticket/current/public/;</div><div class="line">    # do not include &quot;$uri/&quot; in try_files, otherwise @my-app not work</div><div class="line">    try_files $uri @movieticket_app;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location @movieticket_app &#123;</div><div class="line">    passenger_ruby /usr/local/rvm/wrappers/ruby-2.3.3/ruby;</div><div class="line">    passenger_enabled on;</div><div class="line">    root /opt/app/movieticket/current/public;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CentOS-6和7下的启动脚本"><a href="#CentOS-6和7下的启动脚本" class="headerlink" title="CentOS 6和7下的启动脚本"></a>CentOS 6和7下的启动脚本</h2><p>Nginx在各个系统中的启动脚本索引: <a href="https://www.nginx.com/resources/wiki/start/topics/examples/initscripts/" target="_blank" rel="external">NGINX Init Scripts</a></p>
<h3 id="CentOS-7下启动脚本"><a href="#CentOS-7下启动脚本" class="headerlink" title="CentOS 7下启动脚本"></a>CentOS 7下启动脚本</h3><p>CentOS 7下systemd官方推荐脚本: <a href="https://www.nginx.com/resources/wiki/start/topics/examples/systemd/" target="_blank" rel="external">NGINX systemd service file</a></p>
<p>示例如下，其中PIDFile和nginx命令路径按照实际情况配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># vi /lib/systemd/system/nginx.service</div><div class="line"></div><div class="line">--------------------------------</div><div class="line">[Unit]</div><div class="line">Description=The nginx HTTP and reverse proxy server</div><div class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=forking</div><div class="line">PIDFile=/var/run/nginx.pid</div><div class="line">ExecStartPre=/opt/nginx/sbin/nginx -t</div><div class="line">ExecStart=/opt/nginx/sbin/nginx -c /opt/nginx/conf/nginx.conf</div><div class="line">ExecReload=/bin/kill -s HUP $MAINPID</div><div class="line">ExecStop=/bin/kill -s QUIT $MAINPID</div><div class="line">PrivateTmp=true</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">--------------------------------</div></pre></td></tr></table></figure></p>
<p>其中:</p>
<ul>
<li><code>PIDFile</code>需要设置成和nginx.conf中一样的文件</li>
<li>nginx命令路径设成实际安装的路径</li>
<li><code>PrivateTmp</code>按照实际需求设成true或是false。<code>PrivateTmp</code>的意思和passenger搭配的坑，参见之前的博文<a href="/2019/03/10/passenger-status-not-work-on-CentOS-7/" title="CentOS 7下passenger-status报错">CentOS 7下passenger-status报错</a>中systemd PrivateTmp一章的说明</li>
</ul>
<p>启动命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># systemctl enable nginx.service</div><div class="line"># systemctl start nginx.service</div></pre></td></tr></table></figure>
<h3 id="CentOS-6下的启动脚本"><a href="#CentOS-6下的启动脚本" class="headerlink" title="CentOS 6下的启动脚本"></a>CentOS 6下的启动脚本</h3><p>Nginx官方在Red Hat下的init script文章: <a href="https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/" target="_blank" rel="external">Red Hat NGINX Init Script</a></p>
<p>实际使用时，可以根据官网的init脚本进行修改。</p>
<p>如下是passenger默认安装时，手动添加的init脚本的例子, 其中nginx路径为<code>/opt/nginx/sbin/nginx</code>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/init.d/nginx</div><div class="line"></div><div class="line">#!/bin/sh</div><div class="line">#</div><div class="line"># nginx - this script starts and stops the nginx daemon</div><div class="line">#</div><div class="line"># chkconfig:   - 85 15</div><div class="line"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</div><div class="line">#               proxy and IMAP/POP3 proxy server</div><div class="line"># processname: nginx</div><div class="line"># config:      /opt/nginx/conf/nginx.conf</div><div class="line"># config:      /etc/sysconfig/nginx</div><div class="line"># pidfile:     /var/run/nginx.pid</div><div class="line"></div><div class="line"># Source function library.</div><div class="line">. /etc/rc.d/init.d/functions</div><div class="line"></div><div class="line"># Source networking configuration.</div><div class="line">. /etc/sysconfig/network</div><div class="line"></div><div class="line"># Check that networking is up.</div><div class="line">[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0</div><div class="line"></div><div class="line">nginx=&quot;/opt/nginx/sbin/nginx&quot;</div><div class="line">prog=$(basename $nginx)</div><div class="line"></div><div class="line">NGINX_CONF_FILE=&quot;/opt/nginx/conf/nginx.conf&quot;</div><div class="line"></div><div class="line">[ -f /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx</div><div class="line"></div><div class="line">lockfile=/var/lock/subsys/nginx</div><div class="line"></div><div class="line">#make_dirs() &#123;</div><div class="line">#   # make required directories</div><div class="line">#   user=`$nginx -V 2&gt;&amp;1 | grep &quot;configure arguments:&quot; | sed &apos;s/[^*]*--user=\([^ ]*\).*/\1/g&apos; -`</div><div class="line">#   if [ -z &quot;`grep $user /etc/passwd`&quot; ]; then</div><div class="line">#       useradd -M -s /bin/nologin $user</div><div class="line">#   fi</div><div class="line">#   options=`$nginx -V 2&gt;&amp;1 | grep &apos;configure arguments:&apos;`</div><div class="line">#   for opt in $options; do</div><div class="line">#       if [ `echo $opt | grep &apos;.*-temp-path&apos;` ]; then</div><div class="line">#           value=`echo $opt | cut -d &quot;=&quot; -f 2`</div><div class="line">#           if [ ! -d &quot;$value&quot; ]; then</div><div class="line">#               # echo &quot;creating&quot; $value</div><div class="line">#               mkdir -p $value &amp;&amp; chown -R $user $value</div><div class="line">#           fi</div><div class="line">#       fi</div><div class="line">#   done</div><div class="line">#&#125;</div><div class="line"></div><div class="line">start() &#123;</div><div class="line">    [ -x $nginx ] || exit 5</div><div class="line">    [ -f $NGINX_CONF_FILE ] || exit 6</div><div class="line">#    make_dirs</div><div class="line">    echo -n $&quot;Starting $prog: &quot;</div><div class="line">    daemon $nginx -c $NGINX_CONF_FILE</div><div class="line">    retval=$?</div><div class="line">    echo</div><div class="line">    [ $retval -eq 0 ] &amp;&amp; touch $lockfile</div><div class="line">    return $retval</div><div class="line">&#125;</div><div class="line"></div><div class="line">stop() &#123;</div><div class="line">    echo -n $&quot;Stopping $prog: &quot;</div><div class="line">    killproc $prog -QUIT</div><div class="line">    retval=$?</div><div class="line">    echo</div><div class="line">    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile</div><div class="line">    return $retval</div><div class="line">&#125;</div><div class="line"></div><div class="line">restart() &#123;</div><div class="line">    configtest || return $?</div><div class="line">    stop</div><div class="line">    sleep 1</div><div class="line">    start</div><div class="line">&#125;</div><div class="line"></div><div class="line">reload() &#123;</div><div class="line">    configtest || return $?</div><div class="line">    echo -n $&quot;Reloading $prog: &quot;</div><div class="line">    killproc $nginx -HUP</div><div class="line">    RETVAL=$?</div><div class="line">    echo</div><div class="line">&#125;</div><div class="line"></div><div class="line">force_reload() &#123;</div><div class="line">    restart</div><div class="line">&#125;</div><div class="line"></div><div class="line">configtest() &#123;</div><div class="line">  $nginx -t -c $NGINX_CONF_FILE</div><div class="line">&#125;</div><div class="line"></div><div class="line">rh_status() &#123;</div><div class="line">    status $prog</div><div class="line">&#125;</div><div class="line"></div><div class="line">rh_status_q() &#123;</div><div class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</div><div class="line">&#125;</div><div class="line"></div><div class="line">case &quot;$1&quot; in</div><div class="line">    start)</div><div class="line">        rh_status_q &amp;&amp; exit 0</div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        rh_status_q || exit 0</div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    restart|configtest)</div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    reload)</div><div class="line">        rh_status_q || exit 7</div><div class="line">        $1</div><div class="line">        ;;</div><div class="line">    force-reload)</div><div class="line">        force_reload</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        rh_status_q || exit 0</div><div class="line">            ;;</div><div class="line">    *)</div><div class="line">        echo $&quot;Usage: $0 &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest&#125;&quot;</div><div class="line">        exit 2</div><div class="line">esac</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="项目部署中遇到的一些漏洞修补方法"><a href="#项目部署中遇到的一些漏洞修补方法" class="headerlink" title="项目部署中遇到的一些漏洞修补方法"></a>项目部署中遇到的一些漏洞修补方法</h2><h3 id="HTTP-2漏洞-CVE-2019-9511-CVE-2019-9513-CVE-2019-9516"><a href="#HTTP-2漏洞-CVE-2019-9511-CVE-2019-9513-CVE-2019-9516" class="headerlink" title="HTTP/2漏洞 CVE-2019-9511/CVE-2019-9513/CVE-2019-9516"></a>HTTP/2漏洞 CVE-2019-9511/CVE-2019-9513/CVE-2019-9516</h3><p>解决方案，升级到NGINX 1.16.1 (stable)以上<br><a href="https://www.nginx.com/blog/nginx-updates-mitigate-august-2019-http-2-vulnerabilities/" target="_blank" rel="external">NGINX Updates Mitigate the August 2019 HTTP/2 Vulnerabilities</a><br>官方下载地址: <a href="http://nginx.org/download/nginx-1.16.1.tar.gz" target="_blank" rel="external">nginx-1.16.1 </a></p>
<hr>
<h3 id="Web服务器HTTP头信息公开处理"><a href="#Web服务器HTTP头信息公开处理" class="headerlink" title="Web服务器HTTP头信息公开处理"></a>Web服务器HTTP头信息公开处理</h3><h4 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法:"></a>检测方法:</h4><p>通过curl的参数<code>-v</code>来查看header和response的body, 例如 <code>curl -v &#39;http://www.baidu.com/&#39;</code></p>
<h4 id="隐藏nginx版本号的方法"><a href="#隐藏nginx版本号的方法" class="headerlink" title="隐藏nginx版本号的方法:"></a>隐藏nginx版本号的方法:</h4><p>修改nginx.conf文件 在http配置项中增加 <code>server_tokens off;</code></p>
<h4 id="修改源码"><a href="#修改源码" class="headerlink" title="修改源码:"></a>修改源码:</h4><p>修改源码，header中不显示对应的nginx和版本号<br>src/core/nginx.h 修改 NGINX_VER和NGINX_VERSION<br>src/http/ngx_http_header_filter_module.c 中 u_char ngx_http_server_string一行<br>src/http/ngx_http_special_response.c 中 修改 u_char ngx_http_error_tail相关内容</p>
<hr>
<h3 id="移除html-index-html"><a href="#移除html-index-html" class="headerlink" title="移除html/index.html"></a>移除html/index.html</h3><p>默认的index.html和50x.html会泄露nginx信息<br>移除nginx配置下默认的html/index.html</p>
<hr>
<h3 id="设置默认服务不返回任何消息"><a href="#设置默认服务不返回任何消息" class="headerlink" title="设置默认服务不返回任何消息"></a>设置默认服务不返回任何消息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen      80 default_server;</div><div class="line">    server_name _;</div><div class="line">    return      444;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="隐藏Passenger的版本"><a href="#隐藏Passenger的版本" class="headerlink" title="隐藏Passenger的版本"></a>隐藏Passenger的版本</h3><p>5.0.0版本后，在配置文件中设置<code>passenger_show_version_in_header off;</code><br>官方说明<a href="https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_show_version_in_header" target="_blank" rel="external">https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_show_version_in_header</a></p>
<hr>
<h3 id="使用headers-more-nginx-module来去除header"><a href="#使用headers-more-nginx-module来去除header" class="headerlink" title="使用headers-more-nginx-module来去除header"></a>使用headers-more-nginx-module来去除header</h3><p>可以使用扩展<a href="https://github.com/openresty/headers-more-nginx-module#compatibility" target="_blank" rel="external">headers-more-nginx-module</a>来修改nginx中的headers信息。</p>
<h4 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h4><p>passenger-install-nginx-module安装headers-more-nginx-module的步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/openresty/headers-more-nginx-module/archive/v0.33.tar.gz</div><div class="line">tar xzvf v0.33.tar.gz</div><div class="line">cd headers-more-nginx-module-0.33/</div><div class="line">passenger-install-nginx-module --extra-configure-flags=&apos; --add-module=$HOME/headers-more-nginx-module-0.33/&apos;</div></pre></td></tr></table></figure></p>
<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><p>在nginx.conf中server|http的context中设置修改header<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">去掉指定header  --  more_clear_headers  &apos;Server&apos; &apos;X-Powered-By&apos;;</div><div class="line">替换指定header -- more_set_headers</div></pre></td></tr></table></figure></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://ruby-china.org/topics/30439" target="_blank" rel="external">关于如何使用passenger-install-nginx-module中的–extra-configure-flags来安装额外模块的例子</a></li>
<li><a href="https://github.com/openresty/headers-more-nginx-module" target="_blank" rel="external">headers-more-nginx-module Github地址</a></li>
</ul>
<h2 id="Passenger设置最小的instance数目"><a href="#Passenger设置最小的instance数目" class="headerlink" title="Passenger设置最小的instance数目"></a>Passenger设置最小的instance数目</h2><p>passenger关于instance数目有关的几个参数:</p>
<ul>
<li><a href="https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_max_pool_size" target="_blank" rel="external">passenger_max_pool_size</a></li>
<li><a href="https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_min_instances" target="_blank" rel="external">passenger_min_instances</a></li>
<li><a href="https://www.phusionpassenger.com/library/config/nginx/reference/#passenger_max_instances" target="_blank" rel="external">passenger_max_instances</a></li>
</ul>
<p>Ruby代码中，可能会有些Gem存在内存泄露问题。所以passenger_min_instances和passenger_max_pool_size的配置要错开点，不要保持很高的passenger_min_instances数，从而可以让passenger周期性的回收进程，一定程度上可以缓解内存泄露问题。</p>
<p>修改passenger的最大pool size，并且设置passenger_min_instances的例子。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  ...</div><div class="line">  passenger_max_pool_size 40;</div><div class="line">  passenger_pool_idle_time 600;</div><div class="line">  passenger_max_preloader_idle_time 600;</div><div class="line"></div><div class="line">  server &#123;</div><div class="line">    ...</div><div class="line"> passenger_min_instances 16;</div><div class="line"> passenger_max_request_queue_size 1000;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="Nginx官方反向代理的资料"><a href="#Nginx官方反向代理的资料" class="headerlink" title="Nginx官方反向代理的资料"></a>Nginx官方反向代理的资料</h3><ul>
<li>反向代理的Guide<a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/" target="_blank" rel="external">NGINX Reverse Proxy</a></li>
<li>反向代理模块配置<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html?&amp;_ga=2.53566120.1413920519.1592358859-496495264.1591791351#proxy_pass" target="_blank" rel="external">Module ngx_http_proxy_module</a></li>
</ul>
<h3 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    ...</div><div class="line">    server &#123;</div><div class="line">        ...</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass  http://web_production;</div><div class="line">            proxy_redirect     off;</div><div class="line">            proxy_set_header   Host             $host;</div><div class="line">            proxy_set_header   X-Real-IP        $remote_addr;</div><div class="line">            proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</div><div class="line">            proxy_http_version 1.1;</div><div class="line">            proxy_set_header Connection &quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p>之前几篇涉及到反向代理的博文</p>
<ul>
<li><a href="/2019/03/11/ways-to-support-public-s3-file-in-nginx/" title="使用nginx处理S3静态资源">使用nginx处理S3静态资源</a></li>
<li><a href="/2018/11/27/nginx-with-dynamic-upstreams-to-ELB/" title="如何配置Nginx的Dynamic Upstream指向ELB">如何配置Nginx的Dynamic Upstream指向ELB</a>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://nginx.org/en/docs/" target="_blank" rel="external">nginx documentation</a></li>
<li><a href="https://juejin.im/post/5d81906c518825300a3ec7ca" target="_blank" rel="external">nginx 这一篇就够了</a></li>
</ul>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2020/06/14/docker-basic/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2020/06/06/screen-overview-of-ak-tech/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
        <a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a>
        <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
    </div>
    <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};
        with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>


        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>
  
  	 <div id="disqus_thread">
     <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  	 </div>
  
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta">

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2020-06-09
	</div>
	

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Basic验证"><span class="toc-article-text">Basic验证</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#设置htpasswd"><span class="toc-article-text">设置htpasswd</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#配置nginx"><span class="toc-article-text">配置nginx</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#试验"><span class="toc-article-text">试验</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#https配置"><span class="toc-article-text">https配置</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#https配置和例子"><span class="toc-article-text">https配置和例子</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#延伸阅读-SNI"><span class="toc-article-text">延伸阅读: SNI</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#SNI说明"><span class="toc-article-text">SNI说明</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#SNI抓包看协议"><span class="toc-article-text">SNI抓包看协议</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Nginx查看SNI支持"><span class="toc-article-text">Nginx查看SNI支持</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#SNI参考资料"><span class="toc-article-text">SNI参考资料</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Nginx-444"><span class="toc-article-text">Nginx 444</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#配置不响应未知Host的方法"><span class="toc-article-text">配置不响应未知Host的方法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#配置5xx回应为不响应"><span class="toc-article-text">配置5xx回应为不响应</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Nginx-redirect配置"><span class="toc-article-text">Nginx redirect配置</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#配置gzip压缩"><span class="toc-article-text">配置gzip压缩</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#gzip配置"><span class="toc-article-text">gzip配置</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#gzip-static配置"><span class="toc-article-text">gzip_static配置</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#配置最大上传文件限制"><span class="toc-article-text">配置最大上传文件限制</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#日志格式"><span class="toc-article-text">日志格式</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#主目录非根目录nginx配置"><span class="toc-article-text">主目录非根目录nginx配置</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#CentOS-6和7下的启动脚本"><span class="toc-article-text">CentOS 6和7下的启动脚本</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CentOS-7下启动脚本"><span class="toc-article-text">CentOS 7下启动脚本</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CentOS-6下的启动脚本"><span class="toc-article-text">CentOS 6下的启动脚本</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#项目部署中遇到的一些漏洞修补方法"><span class="toc-article-text">项目部署中遇到的一些漏洞修补方法</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#HTTP-2漏洞-CVE-2019-9511-CVE-2019-9513-CVE-2019-9516"><span class="toc-article-text">HTTP/2漏洞 CVE-2019-9511/CVE-2019-9513/CVE-2019-9516</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Web服务器HTTP头信息公开处理"><span class="toc-article-text">Web服务器HTTP头信息公开处理</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#检测方法"><span class="toc-article-text">检测方法:</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#隐藏nginx版本号的方法"><span class="toc-article-text">隐藏nginx版本号的方法:</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#修改源码"><span class="toc-article-text">修改源码:</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#移除html-index-html"><span class="toc-article-text">移除html/index.html</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#设置默认服务不返回任何消息"><span class="toc-article-text">设置默认服务不返回任何消息</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#隐藏Passenger的版本"><span class="toc-article-text">隐藏Passenger的版本</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用headers-more-nginx-module来去除header"><span class="toc-article-text">使用headers-more-nginx-module来去除header</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#安装步骤"><span class="toc-article-text">安装步骤</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#nginx配置"><span class="toc-article-text">nginx配置</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#参考"><span class="toc-article-text">参考</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Passenger设置最小的instance数目"><span class="toc-article-text">Passenger设置最小的instance数目</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#反向代理"><span class="toc-article-text">反向代理</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Nginx官方反向代理的资料"><span class="toc-article-text">Nginx官方反向代理的资料</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#简单例子"><span class="toc-article-text">简单例子</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#相关文章"><span class="toc-article-text">相关文章</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Reference"><span class="toc-article-text">Reference</span></a></li></ol>
		</div>
	
	</div>

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Tools/">Tools<span>36</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>
    <ul id="tags" class="tag_box list-unstyled collapse in">
	    
  <li><a href="/tags/Passenger/">Passenger<span>3</span></a></li> <li><a href="/tags/Nginx/">Nginx<span>11</span></a></li> <li><a href="/tags/Wireshark/">Wireshark<span>1</span></a></li>
    </ul>
	</div>
	

    <hr>

</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'jibing57-blog';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2021 jibing57
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
