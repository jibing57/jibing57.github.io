<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PostgreSQL Tips | Recording</title>
  <meta name="author" content="jibing57">
  
  <meta name="description" content="AWS, 阅读, Architecture, PostgreSQL">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="PostgreSQL Tips"/>
  <meta property="og:site_name" content="Recording"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  
  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111771042-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?59d3e14cdc96877383afed646f44d216";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Recording</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/books" title="Douban">
			  <i class="fa fa-book"></i>Douban
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header ">		
			<h1 class="title "> PostgreSQL Tips</h1>
		</div>		
	




   <style type="text/css">
           img, video {
                -webkit-box-shadow:0 0 10px rgba(0, 0, 0, .5);  
                -moz-box-shadow:0 0 10px rgba(0, 0, 0, .5);  
                box-shadow:0 0 10px rgba(0, 0, 0, .5);  
           }
   </style>



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>收录一些PostgreSQL日常使用的小命令和小配置，备查。</p>
<hr>
<h3 id="将sql结果导入csv文件"><a href="#将sql结果导入csv文件" class="headerlink" title="将sql结果导入csv文件"></a>将sql结果导入csv文件</h3><p>使用\copy命令将sql结果导入csv文件, postgresql命令行中输入以下命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\copy (Select * From foo) To &apos;/tmp/test.csv&apos; With CSV HEADER</div></pre></td></tr></table></figure></p>
<p>Reference :<a href="http://stackoverflow.com/questions/1517635/save-pl-pgsql-output-from-postgresql-to-a-csv-file" target="_blank" rel="external">http://stackoverflow.com/questions/1517635/save-pl-pgsql-output-from-postgresql-to-a-csv-file</a></p>
<a id="more"></a>
<hr>
<h3 id="将shapefile导入postgresql的步骤"><a href="#将shapefile导入postgresql的步骤" class="headerlink" title="将shapefile导入postgresql的步骤"></a>将shapefile导入postgresql的步骤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ createdb -U postgres shape_test</div><div class="line">$ psql -U postgres shape_test -c &quot;CREATE EXTENSION postgis;&quot;;</div><div class="line">CREATE EXTENSION</div><div class="line">$ shp2pgsql -s 4326 SAMPLE_mt_boundary_201510.shp &gt; shape_file.sql</div><div class="line">Shapefile type: Polygon</div><div class="line">Postgis type: MULTIPOLYGON[2]</div><div class="line">$ psql -U postgres shape_test &lt; shape_file.sql</div><div class="line">SET</div><div class="line">SET</div><div class="line">BEGIN</div><div class="line">CREATE TABLE</div><div class="line">ALTER TABLE</div><div class="line">                             addgeometrycolumn</div><div class="line">---------------------------------------------------------------------------</div><div class="line"> public.sample_mt_boundary_201510.geom SRID:4326 TYPE:MULTIPOLYGON DIMS:2</div><div class="line">(1 row)</div><div class="line"></div><div class="line">INSERT 0 1</div><div class="line">INSERT 0 1</div><div class="line">COMMIT</div><div class="line">$</div></pre></td></tr></table></figure>
<p>Reference :</p>
<ul>
<li><a href="http://gis.stackexchange.com/a/41802" target="_blank" rel="external">http://gis.stackexchange.com/a/41802</a></li>
<li><a href="http://www.bostongis.com/pgsql2shp_shp2pgsql_quickguide_20.bqg" target="_blank" rel="external">http://www.bostongis.com/pgsql2shp_shp2pgsql_quickguide_20.bqg</a></li>
</ul>
<hr>
<h3 id="pg-dump多表到一个sql文件中"><a href="#pg-dump多表到一个sql文件中" class="headerlink" title="pg_dump多表到一个sql文件中"></a>pg_dump多表到一个sql文件中</h3><p>可以使用多个-t 参数来dump多张表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pg_dump -U postgres db_name -t table1 -t table 2 &gt; output_sql.sql</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="pg-dump只dump表结构"><a href="#pg-dump只dump表结构" class="headerlink" title="pg_dump只dump表结构"></a>pg_dump只dump表结构</h3><p>使用<code>--schema-only</code>或<code>-s</code>参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pg_dump --schema-only</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="如何不dump表结构，只dump数据"><a href="#如何不dump表结构，只dump数据" class="headerlink" title="如何不dump表结构，只dump数据"></a>如何不dump表结构，只dump数据</h3><p>可以使用<code>--data-only</code>来实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pg_dump --data-only -U postgres db_name -t table1 &gt; output_sql.sql</div></pre></td></tr></table></figure></p>
<p>如果结合<code>--column-inserts</code>参数使用的话，那么就会为每条记录都生成一个insert语句</p>
<p>使用<code>--column-inserts</code>的缺点:</p>
<ol>
<li>sql文件会比较大</li>
<li>从sql恢复(restore)的时候也会很慢.</li>
<li>恢复的时候是单条记录恢复，一条记录错误不会导致整个table的恢复失败, 容易造成数据不完整。</li>
</ol>
<p>但是适合于导出的sql会用于其他non-PostgreSQL的场景<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pg_dump --column-inserts --data-only -U postgres db_name -t table1 &gt; output_sql.sql</div></pre></td></tr></table></figure></p>
<p>Reference : <a href="https://www.postgresql.org/docs/9.3/static/app-pgdump.html" target="_blank" rel="external">https://www.postgresql.org/docs/9.3/static/app-pgdump.html</a></p>
<hr>
<h3 id="在postgresql中建立一个只读用户"><a href="#在postgresql中建立一个只读用户" class="headerlink" title="在postgresql中建立一个只读用户"></a>在postgresql中建立一个只读用户</h3><p>建立用户的命令如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CREATE USER intern2019 WITH LOGIN ENCRYPTED PASSWORD &apos;x!&amp;LosA&amp;@4&apos; VALID UNTIL &apos;infinity&apos;;</div></pre></td></tr></table></figure></p>
<p>对用户授权只读权限的命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">GRANT USAGE ON SCHEMA public TO intern2019;</div><div class="line">GRANT SELECT ON ALL TABLES IN SCHEMA public To intern2019;  -- only effect by current table</div><div class="line">ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO intern2019; -- effect by all new table</div></pre></td></tr></table></figure>
<p>删除某个用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ALTER DEFAULT PRIVILEGES IN SCHEMA public revoke SELECT ON TABLES FROM intern2019</div><div class="line">REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM intern2019;</div><div class="line">REVOKE USAGE ON SCHEMA public FROM intern2019</div><div class="line"></div><div class="line">DROP USER intern2019;</div></pre></td></tr></table></figure>
<hr>
<h3 id="如何在group-by中统计基于group-by字段和其他条件的记录的总数"><a href="#如何在group-by中统计基于group-by字段和其他条件的记录的总数" class="headerlink" title="如何在group by中统计基于group by字段和其他条件的记录的总数"></a>如何在group by中统计基于group by字段和其他条件的记录的总数</h3><p>sum函数中，可以结合case when来统计符合某些条件的总数，在group by的时候，就可以顺带让Postgresql来检查计算符合条件的记录总数，比简单粗暴的子查询来的快速。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select mls_id, mls_name, SUM( CASE WHEN (trs_type=&apos;long term rentals&apos; or trs_type=&apos;&apos; or trs_type is null) THEN 1 ELSE 0 END) as rental_num, SUM( CASE WHEN (trs=&apos;for sale&apos;) THEN 1 ELSE 0 END) as for_sale_num  from listings  where active=true and validity=true group by mls_id, mls_name order by mls_id</div></pre></td></tr></table></figure>
<p>Reference:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/24030674/postgres-aggregating-conditional-sum" target="_blank" rel="external">http://stackoverflow.com/questions/24030674/postgres-aggregating-conditional-sum</a></li>
<li><a href="http://stackoverflow.com/questions/2045463/sql-query-to-conditionally-sum-based-on-moving-date-window" target="_blank" rel="external">http://stackoverflow.com/questions/2045463/sql-query-to-conditionally-sum-based-on-moving-date-window</a></li>
</ul>
<hr>
<h3 id="PG的时间函数"><a href="#PG的时间函数" class="headerlink" title="PG的时间函数"></a>PG的时间函数</h3><p>原字段加上<code>interval &#39;1 second&#39;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">postgres=# select NOW(), NOW()+interval &apos;1 second&apos;;</div><div class="line">             now              |           ?column?</div><div class="line">------------------------------+------------------------------</div><div class="line"> 2017-01-09 14:49:38.52691+08 | 2017-01-09 14:49:39.52691+08</div><div class="line">(1 row)</div><div class="line"></div><div class="line">postgres=#</div></pre></td></tr></table></figure>
<hr>
<h3 id="查看数据库中各个表上次vacuum和autovacuum时间的sql"><a href="#查看数据库中各个表上次vacuum和autovacuum时间的sql" class="headerlink" title="查看数据库中各个表上次vacuum和autovacuum时间的sql"></a>查看数据库中各个表上次vacuum和autovacuum时间的sql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">partition_test=# select relname,last_vacuum, last_autovacuum, last_analyze, last_autoanalyze from pg_stat_user_tables;</div><div class="line"> relname  |          last_vacuum          | last_autovacuum |         last_analyze          | last_autoanalyze</div><div class="line">----------+-------------------------------+-----------------+-------------------------------+------------------</div><div class="line"> user_new | 2017-05-10 09:30:06.156982+08 |                 | 2017-05-10 09:30:06.181667+08 |</div><div class="line"> users    | 2017-05-10 09:29:51.52591+08  |                 |                               |</div><div class="line">(2 rows)</div><div class="line"></div><div class="line">partition_test=#</div></pre></td></tr></table></figure>
<hr>
<h3 id="Postgis中比较geometry类型的值的方法"><a href="#Postgis中比较geometry类型的值的方法" class="headerlink" title="Postgis中比较geometry类型的值的方法"></a>Postgis中比较geometry类型的值的方法</h3><p>使用ST_Equals<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select id, source, lat, lon, geom4326, geom, created_at, updated_at from properties where not ST_Equals(geom4326, ST_SetSRID(ST_MakePoint(lon, lat),  4326)) or not ST_Equals(geom, ST_SetSRID(ST_MakePoint(lon, lat), 4269)) limit 1;</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="PG中查看sql执行时间的方法"><a href="#PG中查看sql执行时间的方法" class="headerlink" title="PG中查看sql执行时间的方法"></a>PG中查看sql执行时间的方法</h3><p>使用<code>\timing</code>来显示sql执行时间，再次输入<code>\timing</code>关闭显示时间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">postgres=# \timing</div><div class="line">Timing is on.</div><div class="line">postgres=# select 1;</div><div class="line"> ?column?</div><div class="line">----------</div><div class="line">        1</div><div class="line">(1 row)</div><div class="line"></div><div class="line">Time: 0.214 ms</div><div class="line">postgres=# \timing</div><div class="line">Timing is off.</div><div class="line">postgres=#</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="切割第一个字符串是不是数字的sql"><a href="#切割第一个字符串是不是数字的sql" class="headerlink" title="切割第一个字符串是不是数字的sql"></a>切割第一个字符串是不是数字的sql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select split_part(&apos;10059 Pine Glade Dr&apos;, &apos; &apos; ,1)~&apos;^([0-9]+\.?[0-9]*|\.[0-9]+)$&apos;;</div></pre></td></tr></table></figure>
<hr>
<h3 id="如何建索引时不锁表"><a href="#如何建索引时不锁表" class="headerlink" title="如何建索引时不锁表"></a>如何建索引时不锁表</h3><p>Postgresql创建index时，默认是要锁表的。可以通过添加<code>CONCURRENTLY</code>参数，在不锁表的情况下建立索引。<br>但需要多次扫描，因此建索引时间会比较久<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create index CONCURRENTLY index_feeds_on_take_id on feeds(take_id);</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="一些常用的psql命令"><a href="#一些常用的psql命令" class="headerlink" title="一些常用的psql命令"></a>一些常用的psql命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">\l  -- 列出所有数据库,数据库字符集等</div><div class="line">\l+ -- 列出所有数据库, 也包含数据库size</div><div class="line">\c DATABASE_NAME  -- 使用某个数据库</div><div class="line">\d  -- 查看表列表,包含sequence</div><div class="line">\dt -- 查看数据库中的表，不包含sequence</div><div class="line">\d+ -- 查看表列表(带Size和Description)</div><div class="line">\d TABLE_NAME -- 查看表结构</div><div class="line">\d+ TABLE_NAME -- 查看表结构，更多信息，比如可显示子表等</div><div class="line">\df -- 列出所有的function</div><div class="line">\df+ FUNCTION_NAME -- 列出某个function的详细信息</div><div class="line">\x  -- 打开扩展显示</div><div class="line">\q  -- 退出</div></pre></td></tr></table></figure>
<hr>
<h3 id="数据库磁盘容量命令"><a href="#数据库磁盘容量命令" class="headerlink" title="数据库磁盘容量命令"></a>数据库磁盘容量命令</h3><p>数据库中所有表磁盘空间的命令,包含各个表的大小，索引的大小<br><a href="http://stackoverflow.com/questions/2596624/how-do-you-find-the-disk-size-of-a-postgres-postgresql-table-and-its-indexes" target="_blank" rel="external">http://stackoverflow.com/questions/2596624/how-do-you-find-the-disk-size-of-a-postgres-postgresql-table-and-its-indexes</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">SELECT</div><div class="line">    table_name,</div><div class="line">    pg_size_pretty(table_size) AS table_size,</div><div class="line">    pg_size_pretty(indexes_size) AS indexes_size,</div><div class="line">    pg_size_pretty(total_size) AS total_size</div><div class="line">FROM (</div><div class="line">    SELECT</div><div class="line">        table_name,</div><div class="line">        pg_table_size(table_name) AS table_size,</div><div class="line">        pg_indexes_size(table_name) AS indexes_size,</div><div class="line">        pg_total_relation_size(table_name) AS total_size</div><div class="line">    FROM (</div><div class="line">        SELECT (&apos;&quot;&apos; || table_schema || &apos;&quot;.&quot;&apos; || table_name || &apos;&quot;&apos;) AS table_name</div><div class="line">        FROM information_schema.tables</div><div class="line">    ) AS all_tables</div><div class="line">    ORDER BY total_size DESC</div><div class="line">) AS pretty_sizes</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="PG中重建索引"><a href="#PG中重建索引" class="headerlink" title="PG中重建索引"></a>PG中重建索引</h3><p>Postgresql中的索引是不停增长的，当数据被反复删除，更新后，索引文件会变得异常的巨大,称之为”bloated”。<br>使用<code>reindex</code>来重建索引，可以减少磁盘空间，提升索引效率。<br>但直接<code>reindex</code>重建索引会存在锁表现象。在PostgreSQL 12中才支持<code>reindex</code>的CONCURRENTLY参数。<br>12以下的版本中，只能通过手动新建和删除索引的方法来实现。方法如下:</p>
<ol>
<li><p>以schema是public,tablename是’feed_records’为例，列出该表下所有索引以及其大小的sql如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">SELECT</div><div class="line">    t.tablename,</div><div class="line">    indexname,</div><div class="line">    c.reltuples AS num_rows,</div><div class="line">    pg_size_pretty(pg_relation_size(quote_ident(t.tablename)::text)) AS table_size,</div><div class="line">    pg_size_pretty(pg_relation_size(quote_ident(indexrelname)::text)) AS index_size,</div><div class="line">    CASE WHEN indisunique THEN &apos;Y&apos;</div><div class="line">       ELSE &apos;N&apos;</div><div class="line">    END AS UNIQUE,</div><div class="line">    idx_scan AS number_of_scans,</div><div class="line">    idx_tup_read AS tuples_read,</div><div class="line">    idx_tup_fetch AS tuples_fetched</div><div class="line">FROM pg_tables t</div><div class="line">LEFT OUTER JOIN pg_class c ON t.tablename=c.relname</div><div class="line">LEFT OUTER JOIN</div><div class="line">    ( SELECT c.relname AS ctablename, ipg.relname AS indexname, x.indnatts AS number_of_columns, idx_scan, idx_tup_read, idx_tup_fetch, indexrelname, indisunique FROM pg_index x</div><div class="line">           JOIN pg_class c ON c.oid = x.indrelid</div><div class="line">           JOIN pg_class ipg ON ipg.oid = x.indexrelid</div><div class="line">           JOIN pg_stat_all_indexes psai ON x.indexrelid = psai.indexrelid )</div><div class="line">    AS foo</div><div class="line">    ON t.tablename = foo.ctablename</div><div class="line">WHERE t.schemaname=&apos;public&apos; and t.tablename=&apos;feed_records&apos;</div><div class="line">ORDER BY 1,2;</div></pre></td></tr></table></figure>
</li>
<li><p>选一个负载小的时间，重建索引。步骤:</p>
<ul>
<li>新增一个同原索引内容相同的临时索引A’</li>
<li>删除原来的索引A</li>
<li>重新建原来的索引A</li>
<li>删除新建的临时索引A’<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">以重建feed_records中last_update_time字段的索引为例</div><div class="line">\d feed_records;</div><div class="line">create index CONCURRENTLY xxx_index_feed_records_on_last_update_time on feed_records(last_update_time);</div><div class="line">drop index index_feed_records_on_last_update_time;</div><div class="line">create index CONCURRENTLY index_feed_records_on_last_update_time on feed_records(last_update_time);</div><div class="line">drop index xxx_index_feed_records_on_last_update_time;</div><div class="line">\d feed_records;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="数据库导出和恢复"><a href="#数据库导出和恢复" class="headerlink" title="数据库导出和恢复"></a>数据库导出和恢复</h3><p>数据库导出和恢复命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 导出数据和表，不包含drop语句 </div><div class="line">pg_dump --host localhost --username postgres --dbname mydatabase &gt; db.sql</div><div class="line"># 导出数据和表，添加-c参数后，会包含drop语句 </div><div class="line">pg_dump --host localhost --username postgres --dbname mydatabase -c &gt; db.sql</div><div class="line"># 恢复表</div><div class="line">psql --host localhost --username postgres --dbname mydatabase &lt; db.sql</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="pg-dump和pg-restore加速"><a href="#pg-dump和pg-restore加速" class="headerlink" title="pg_dump和pg_restore加速"></a>pg_dump和pg_restore加速</h3><p>pg_dump在大数据量下dump和restore速度很慢，可以使用-j参数来起多个job并行操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ pg_dump --host localhost -j8 -Fd -v -Uintern -d web_v2_staging -f web_v2_staging_dump</div><div class="line">$ pg_restore --verbose --clean --no-acl --no-owner -h localhost -d web_v3_staging -Uintern -j8 --format=d web_v2_staging_dump</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="输出结果中显示NULL字串"><a href="#输出结果中显示NULL字串" class="headerlink" title="输出结果中显示NULL字串"></a>输出结果中显示NULL字串</h3><p>psql的默认输出格式中，没法区分NULL和空字串，使用<code>\pset null (null)</code>来显示NULL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">postgres=# \pset null (null);</div><div class="line">Null display is &quot;(null);&quot;.</div><div class="line">postgres=# select NULL;</div><div class="line"> ?column?</div><div class="line">----------</div><div class="line"> (null);</div><div class="line">(1 row)</div><div class="line"></div><div class="line">postgres=#</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="explain-analyze用来定位慢查询"><a href="#explain-analyze用来定位慢查询" class="headerlink" title="explain analyze用来定位慢查询"></a>explain analyze用来定位慢查询</h3><p>针对慢查询，使用<code>explain</code>和<code>explain analyze</code>来定位问题。<br><code>explain</code>只做评估，并不真正执行sql。<br><code>explain analyze</code>会直接运行sql。<br>一般还需开启<code>\timing</code>来使用</p>
<hr>
<h3 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h3><p>修改密码的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ALTER ROLE username WITH PASSWORD &apos;password&apos;;</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="查看所有的参数"><a href="#查看所有的参数" class="headerlink" title="查看所有的参数"></a>查看所有的参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show all</div></pre></td></tr></table></figure>
<hr>
<h3 id="AWS-RDS-Postgresql-master-replicate要修改的几个配置"><a href="#AWS-RDS-Postgresql-master-replicate要修改的几个配置" class="headerlink" title="AWS RDS Postgresql master/replicate要修改的几个配置"></a>AWS RDS Postgresql master/replicate要修改的几个配置</h3><p>Master参数修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wal_keep_segments: 需要需要设大一点，否则写过多的话，会导致replica暂停流复制，从S3下载archived WAL来恢复数据</div><div class="line">random_page_cost: 设为seq_page_cost一样的值，默认random_page_cost是4，seq_page_cost是1。SSD磁盘下可以认为顺序查找和随机查找开销是一样的。</div></pre></td></tr></table></figure></p>
<p>Replica参数修改<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hot_standby_feedback: 设为1，防止replica查询还在执行时，Master已经将受影响的数据清理掉并同步给replica，导致replica上的查询失败。</div><div class="line">random_page_cost: 设为seq_page_cost一样的值，默认random_page_cost是4，seq_page_cost是1。SSD磁盘下可以认为顺序查找和随机查找开销是一样的。</div></pre></td></tr></table></figure></p>
<p><strong>Reference:</strong> <a href="https://amazonaws-china.com/blogs/database/best-practices-for-amazon-rds-postgresql-replication/" target="_blank" rel="external">Best practices for Amazon RDS PostgreSQL replication</a></p>
<hr>
<h3 id="查看数据库支持的扩展"><a href="#查看数据库支持的扩展" class="headerlink" title="查看数据库支持的扩展"></a>查看数据库支持的扩展</h3><p>查看当前数据库的pg扩展命令<code>SELECT * FROM pg_extension;</code>或者<code>\dx</code><br>查看服务器支持的pg扩展<code>SELECT * FROM pg_available_extensions;</code></p>
<hr>
<h3 id="使用SSL-TLS连接数据库"><a href="#使用SSL-TLS连接数据库" class="headerlink" title="使用SSL/TLS连接数据库"></a>使用SSL/TLS连接数据库</h3><p>psql中通过添加<code>sslmode</code>指定模式以及<code>sslrootcert</code>指定cert路径来使用SSL/TLS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psql &quot;sslmode=verify-full sslrootcert=./rds-ca-2019-root.pem host=staging-replica.xxxxxxxxxxx.us-east-1.rds.amazonaws.com port=5432 user=db_user dbname=db_name&quot;</div></pre></td></tr></table></figure></p>
<p><code>sslmode</code>的说明摘录如下, 来自: <a href="https://www.postgresql.org/docs/9.6/libpq-ssl.html" target="_blank" rel="external">https://www.postgresql.org/docs/9.6/libpq-ssl.html</a></p>
<table>
<thead>
<tr>
<th>sslmode</th>
<th>Eavesdropping protection</th>
<th>MITM protection</th>
<th>Statement</th>
</tr>
</thead>
<tbody>
<tr>
<td>disable</td>
<td>No</td>
<td>No</td>
<td>I don’t care about security, and I don’t want to pay the overhead of encryption.</td>
</tr>
<tr>
<td>allow</td>
<td>Maybe</td>
<td>No</td>
<td>I don’t care about security, but I will pay the overhead of encryption if the server insists on it.</td>
</tr>
<tr>
<td>prefer</td>
<td>Maybe</td>
<td>No</td>
<td>I don’t care about encryption, but I wish to pay the overhead of encryption if the server supports it.</td>
</tr>
<tr>
<td>require</td>
<td>Yes</td>
<td>No</td>
<td>I want my data to be encrypted, and I accept the overhead. I trust that the network will make sure I always connect to the server I want.</td>
</tr>
<tr>
<td>verify-ca</td>
<td>Yes</td>
<td>Depends on CA-policy</td>
<td>I want my data encrypted, and I accept the overhead. I want to be sure that I connect to a server that I trust.</td>
</tr>
<tr>
<td>verify-full</td>
<td>Yes</td>
<td>Yes</td>
<td>I want my data encrypted, and I accept the overhead. I want to be sure that I connect to a server I trust, and that it’s the one I specify.</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="刷新sequence为表的最大值"><a href="#刷新sequence为表的最大值" class="headerlink" title="刷新sequence为表的最大值"></a>刷新sequence为表的最大值</h3><h4 id="更新单表"><a href="#更新单表" class="headerlink" title="更新单表"></a>更新单表</h4><p>Postgresql的主键自增是通过sequence机制来实现的。重建或者手动insert数据的时候，sequence可能不会被更新。<br>此时，可以手动更新sequence中的last_value为对应表的最大值。</p>
<p>以users表为例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT setval(&apos;users_id_seq&apos;, (SELECT MAX(id) FROM users));</div></pre></td></tr></table></figure></p>
<h4 id="更新全部表"><a href="#更新全部表" class="headerlink" title="更新全部表"></a>更新全部表</h4><p><a href="https://wiki.postgresql.org" target="_blank" rel="external">https://wiki.postgresql.org</a>上有更新全部表sequence的方法<a href="https://wiki.postgresql.org/wiki/Fixing_Sequences" target="_blank" rel="external">Fixing Sequences</a></p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2019/10/31/why-format-painter-not-working-on-mac-office-365/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2019/10/18/AWS-Advanced-Networking-Specialty/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
        <a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a>
        <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
    </div>
    <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};
        with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>


        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>
  
  	 <div id="disqus_thread">
     <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  	 </div>
  
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta">

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2019-10-27
	</div>
	

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
			<ol class="toc-article"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#将sql结果导入csv文件"><span class="toc-article-text">将sql结果导入csv文件</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#将shapefile导入postgresql的步骤"><span class="toc-article-text">将shapefile导入postgresql的步骤</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#pg-dump多表到一个sql文件中"><span class="toc-article-text">pg_dump多表到一个sql文件中</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#pg-dump只dump表结构"><span class="toc-article-text">pg_dump只dump表结构</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#如何不dump表结构，只dump数据"><span class="toc-article-text">如何不dump表结构，只dump数据</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#在postgresql中建立一个只读用户"><span class="toc-article-text">在postgresql中建立一个只读用户</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#如何在group-by中统计基于group-by字段和其他条件的记录的总数"><span class="toc-article-text">如何在group by中统计基于group by字段和其他条件的记录的总数</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PG的时间函数"><span class="toc-article-text">PG的时间函数</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#查看数据库中各个表上次vacuum和autovacuum时间的sql"><span class="toc-article-text">查看数据库中各个表上次vacuum和autovacuum时间的sql</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Postgis中比较geometry类型的值的方法"><span class="toc-article-text">Postgis中比较geometry类型的值的方法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PG中查看sql执行时间的方法"><span class="toc-article-text">PG中查看sql执行时间的方法</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#切割第一个字符串是不是数字的sql"><span class="toc-article-text">切割第一个字符串是不是数字的sql</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#如何建索引时不锁表"><span class="toc-article-text">如何建索引时不锁表</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#一些常用的psql命令"><span class="toc-article-text">一些常用的psql命令</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#数据库磁盘容量命令"><span class="toc-article-text">数据库磁盘容量命令</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PG中重建索引"><span class="toc-article-text">PG中重建索引</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#数据库导出和恢复"><span class="toc-article-text">数据库导出和恢复</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#pg-dump和pg-restore加速"><span class="toc-article-text">pg_dump和pg_restore加速</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#输出结果中显示NULL字串"><span class="toc-article-text">输出结果中显示NULL字串</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#explain-analyze用来定位慢查询"><span class="toc-article-text">explain analyze用来定位慢查询</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#修改用户密码"><span class="toc-article-text">修改用户密码</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#查看所有的参数"><span class="toc-article-text">查看所有的参数</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#AWS-RDS-Postgresql-master-replicate要修改的几个配置"><span class="toc-article-text">AWS RDS Postgresql master/replicate要修改的几个配置</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#查看数据库支持的扩展"><span class="toc-article-text">查看数据库支持的扩展</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#使用SSL-TLS连接数据库"><span class="toc-article-text">使用SSL/TLS连接数据库</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#刷新sequence为表的最大值"><span class="toc-article-text">刷新sequence为表的最大值</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#更新单表"><span class="toc-article-text">更新单表</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#更新全部表"><span class="toc-article-text">更新全部表</span></a></li></ol></li></ol>
		</div>
	
	</div>

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Tools/">Tools<span>27</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>
    <ul id="tags" class="tag_box list-unstyled collapse in">
	    
  <li><a href="/tags/PostgreSQL/">PostgreSQL<span>4</span></a></li>
    </ul>
	</div>
	

    <hr>

</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
var disqus_shortname = 'jibing57-blog';
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 jibing57
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
